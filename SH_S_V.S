;
;******************************************************************
;
;                       SHADOW ROM SYSTEM VARIABLES
;
;******************************************************************
;
*INCLUDE	NEWVAR.S
;
;

;  SYSTEM RESTARTS

R_BASE:	EQU	0000H
ENTRY:	EQU	0008H
CALBAS:	EQU	0010H
SYNT:	EQU	0018H
SH_ERR:	EQU	0020H
ROMERR:	EQU	0028H
INSER_	EQU	0030H
MASK:	EQU	0038H


;  BASE ROM ADDRESSES

LAST_K	EQU	5C08H
DEFADD	EQU	5C0BH
STRMS	EQU	5C10H
Y	EQU	5C3AH
ERR_NR	EQU	5C3AH
FLAGS	EQU	5C3BH
TV_FLAG	EQU	5C3CH
ERR_SP	EQU	5C3DH
NEWPPC	EQU	5C42H
NSPPC	EQU	5C44H
PPC	EQU	5C45H
SUBPPC	EQU	5C47H
BORDCR	EQU	5C48H
VARS	EQU	5C4BH
CHANS_	EQU	5C4FH
CURCHL	EQU	5C51H
PROG	EQU	5C53H
DATADD	EQU	5C57H
E_LINE	EQU	5C59H
CH_ADD	EQU	5C5DH
X_PTR	EQU	5C5FH
FLAGS2	EQU	5C6AH
FLAGX	EQU	5C71H
UDG	EQU	5C7BH
SCRCT	EQU	5C8CH
ATTR_P	EQU	5C8DH
ATTR_T	EQU	5C8FH
P_FLAG	EQU	5C91H
DR	EQU	5CB6H



;
;*************************************************
;*      FIXED MICRODRIVE DATA                    *
;*************************************************
;
;
; THIS FIXED DATA IS FOUND IMMEDIATELY AFTER THE SYSTEM VARIABLES
; THE SPACE IS CREATED WHEN THE SHADOW ROM IF FIRST CALLED
;
FLAGS3	EQU	DR		; 23734		; BIT 0 ... RECURSION
						; BIT 1 ... AUTO RUN
						; BIT 2 ... HOOK
						; BIT 3 ... NET/RS232
						; BIT 4 ... LOAD
						; BIT 5 ... SAVE
						; BIT 6 ... MERGE
						; BIT 7 ... VERIFY
XR	EQU 	7				; INDICATES VERIFY NOT LOAD
VECTOR	EQU 	01H		; 23735/6	; NEW COMMAND VECTOR POINT
SBRT	EQU 	VECTOR+02H	; 23737		; START OF CALBAS SUBROUTINE
H_L	EQU 	SBRT+01H
ZILCH	EQU 	SBRT+04H
BAUD	EQU 	SBRT+0AH	; 23747		; RATE FOR RS232
NTSTAT	EQU 	BAUD+02H	; 23749		; 'OWN' STATION NUMBER
IOBORD	EQU 	NTSTAT+01H	; 23750		; BORDER COLOR FOR I/O
SER_FL	EQU 	IOBORD+01H	; 23751		; SERIAL INPUT FLAG & CHARACTER

		; END OF DEFAULT SYS. VARS


		; START OF VARIABLES

SECTOR	EQU	SER_FL+02H+DR	; 23753		; MICRODRIVE SECTOR
CHADD_	EQU	SECTOR+02H-DR	; 23755		; TEMPORARY STORE FOR CH_ADD
NTRESP	EQU	CHADD_+02H	; 23757		; STORE FOR RESPONSE CODE

		; THE EIGHT LOCATIONS FOR A NET HEADER

NTDEST	EQU	NTRESP+01H	; 23758		; DESTINATION STATION NUMBER
NTSRCE	EQU	NTDEST+01H	; 23759		; SOURCE STATION NUMBER
NTNUMB	EQU	NTSRCE+01H	; 23760		; BLOCK NUMBER
NTTYPE	EQU	NTNUMB+02H	; 23762		; 'DATA' (0) OR 'CLOSE' (1) TYPE CODE
NTLEN	EQU	NTTYPE+01H	; 23763		; DATA BLOCK LENGTH
NTDCS	EQU	NTLEN+01H	; 23764		; DATA CHECKSUM
NTHCS	EQU	NTDCS+01H	; 23765		; HEADER CHECKSUM

		; THE SIXTEEN LOCATIONS FOR PARAMETER COLLECTION

D_STR1	EQU	NTHCS+01H	; 23766		; TWO BYTE NUMBER
S_STR1	EQU	D_STR1+02H	; 23768		; STREAM NUMBER
L_STR1	EQU	D_STR1+03H	; 23769		; LETTER
N_STR1	EQU	D_STR1+04H	; 23770		; NAME DETAILS (LENGTH & START)
D_STR2	EQU	D_STR1+08H	; 23774		; ** SECOND SET **
S_STR2	EQU	D_STR1+0AH	; 23776
L_STR2	EQU	D_STR1+0BH	; 23777
N_STR2	EQU	D_STR1+0CH	; 23778


SC_00	EQU	D_STR1+08H	; 23774		; SECOND SET FOR SCANN
SC_0B	EQU	D_STR1+09H	; 23775
SC_0D	EQU	D_STR1+0BH	; 23777
SC_0F	EQU	D_STR1+0DH	; 23779



		; THE NINE LOCATIONS FOR 'SAVE', 'LOAD' ETC.

HD_00	EQU	D_STR1+10H	; 23782		; TYPE CODE
HD_0B	EQU	HD_00+01H	; 23783		; LENGTH OF BLOCK
HD_0C	EQU	HD_0B+01H	; 23784
HD_0D	EQU	HD_0C+01H	; 23785		; START OF BLOCK
HD_0E	EQU	HD_0D+01H	; 23786
HD_0F	EQU	HD_0E+01H	; 23787		; PROGRAM LENGTH
HD_10	EQU	HD_0F+01H	; 23788
HD_11	EQU	HD_10+01H	; 23789		; LINE NUMBER
HD_12	EQU	HD_11+01H	; 23790

COPIES	EQU	HD_12+1		; 23791

ROMADD	EQU	HD_10+01H	; 23789		; PASSING ADDRESS FOR HOOKS

DR_LEN	EQU	COPIES+01H
N_LEN	EQU	0114H				; LENGTH OF A NET BUFFER

;  RS232 PORT DETAILS

RS232	EQU	0F7H				; SERIAL DATA PORT
KB_PT	EQU	0FEH				; KEYBOARD PORT
STATUS	EQU	0EFH				; SERIAL STATUS PORT
DTR	EQU	08H				; MASK FOR DTR OUTPUT

; NET PORT DETAILS
SERIAL	EQU	0F7H				; SERIAL DATA PORT
WAIT	EQU	0EFH				; WAIT PORT

;
;
;************************************************
;*    MACROS                                    *
;************************************************
;
RST	MACRO	#ADDR				; THIS MACRO WILL BE USED TO FLAG
	RST	#ADDR				; CALLS TO THE ROM WHEN THIS S/WARE
	ENDM					; IS CONVERTED TO SHADOW ROM FORM.
;
ASSERT	MACRO   #COND
	COND .NOT.(#COND)
	ENDC
	ENDM
;
OLDCAL	MACRO	#SUB
	RST	CALBAS
	DEFW	#SUB
	ENDM
;
OLDJP	MACRO	#DEST
	JP	#DEST
	ENDM
;
;
;
;********************************************
;*   DATA                                   *
;********************************************
;
;
;********************CHANNEL***************
;
;
; THE FOLLOWING DATA IS CREATE'D FOR EVERY OPEN MICRODRIVE FILE
; AND SOMETIMES FOR A WORKSPACE IN MICRODRIVE OPERATIONS
;
;
; OLD WRCH ADDRESS POINTS TO 0008
; OLD RDCH ADDRESS POINTS TO 0008
CHTYPE	EQU	4				; CHANNEL TYPE
; NEW WRCH ADDRESS
; NEW RDCH ADDRESS
CHLEN	EQU	CHTYPE+5			; LENGTH OF THIS CHANNEL DATA
CHBYTE  EQU	CHLEN+2				; CURRENT BYTE POINTER
CHREC   EQU	CHBYTE+2			; CURRENT RECORD
CHNAME  EQU	CHREC+1				; 10 BYTE FILE NAME
CHFLAG  EQU	CHNAME+10			; CHANNEL FLAGS
;
WRFLG	EQU	0				; WRITE FLAG BIT
;
CHDRIV	EQU	CHFLAG+1			; DRIVE NUMBER 0-7
CHMAP	EQU	CHDRIV+1			; ADDRESS OF DRIVE MAP FOR THIS FILE
;
CHHDR	EQU	CHMAP+2				; START OF HEADER
HDFLAG	EQU	CHHDR+PLEN			; FLAG BYTE AT START OF HEADER (BIT0=1)
HDNUMB	EQU	HDFLAG+1			; NUMBER OF CURRENT HEADER/SECTOR
						; FOLLOWED BY TWO EMPTY BYTES
HDNAME	EQU	HDNUMB+3			; TAPE NAME
HDCHK	EQU	HDNAME+10			; HEADER CHECKSUM
;
; TOTAL LENGTH OF THE ABOVE PLEN + 15
;
CHDES	EQU	HDCHK+1				; START OF DESCRIPTOR
RECFLG	EQU	CHDES+PLEN			; FLAG BYTE IN DESCRIPTOR (BIT0=1)
						; BIT 1 = EOF
						; BIT 2 = SLVM
RECNUM	EQU	RECFLG+1			; NUMBER OF THIS RECORD
RECLEN	EQU	RECNUM+1			; LENGTH OF THIS RECORD
RECNAM	EQU	RECLEN+2			; NAME OF THIS RECORD
DESCHK	EQU	RECNAM+10			; DESCRIPTOR CHECKSUM
CHDATA	EQU	DESCHK+1			; START OF DATA BLOCK
DCHK	EQU	CHDATA+512			; DATA CHECKSUM
;
CHANLN	EQU	DCHK+1				; LENGTH OF ALL THIS
;
;*************MAP****************************
;
; A MICRODRIVE MAP IS A BIT MAP OF ALL SECTORS ON A MICRODRIVE
; THE BITS ARE COUNTED FROM 0 TO HD_MAX-1 THE LENGTH
; OF THE MAP IS THEREFORE GIVEN BY:-
;
MAPLN	EQU	32
;
; THE MAP IS CREATE'D FOR EVERY DRIVE CONTAINING AN OPEN FILE
;
